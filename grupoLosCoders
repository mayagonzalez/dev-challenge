import json
from urllib.request import urlopen

from string import Template
import smtplib
# import necessary packages
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText

url = ["https://images.tcdn.com.br/dev-challenge/cart/4rashtk3sdquptms4md2q2h485.json", 
       "https://images.tcdn.com.br/dev-challenge/cart/huni2lib7i0hkbie6vvg7n46t4.json", 
       "https://images.tcdn.com.br/dev-challenge/cart/kobq972itl2rqugoa5v2k7e3j7.json",
       "https://images.tcdn.com.br/dev-challenge/cart/qami6pqhjbvgqfh7qqmh4sdud2.json",
       "https://images.tcdn.com.br/dev-challenge/cart/teh1jg167q6k50o2ejermke7u5.json"]

for j in url:
  response = urlopen(j)
  data_json = json.loads(response.read())
  products = []

  for i in data_json:
    email = i['Cart']['email']
    product_name = i['Cart']['product_name']
    price = i['Cart']['price']
    product_url = i['Cart']['product_url']['https']
    product_image = i['Cart']['product_image']['https']
    products.append([product_name, product_image, price, product_url])

    email_title = 'Ops! Algumas coisas estÃ£o aguardando no seu carrinho'

    email_body = "Um carrinho tambÃ©m se sente abandonado! ðŸ˜¢ /n Esperamos que vocÃª esteja bem! Estes produtos incrÃ­veis ainda estÃ£o esperando por vocÃª. /n NÃ£o perca a oportunidade de levar para casa esses produtos com 5% de desconto."
    
    for p in products:
      email_products = "/n {product_image} /n {product_name} /n {price} /n {product_url}".format(
      product_image=p[1],
      product_name=p[0],
      price=p[2],
      product_url=p[3])


  full_body = email_body + email_products

  print(email_title)
  print(full_body)

email_text = '{ "to":[ {"email": ' +  email + ', }], "from": { "email": "sales@example.com", "name": "Example Sales Team" }, "attachments": [ {"content": "PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KCiAgICA8aGVhZD4KICAgICAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICAgICAgPG1ldGEgaHR0cC1lcXVpdj0iWC1VQS1Db21wYXRpYmxlIiBjb250ZW50PSJJRT1lZGdlIj4KICAgICAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMCI+CiAgICAgICAgPHRpdGxlPkRvY3VtZW50PC90aXRsZT4KICAgIDwvaGVhZD4KCiAgICA8Ym9keT4KCiAgICA8L2JvZHk+Cgo8L2h0bWw+Cg==",       "filename": "index.html",       "type": "text/html","disposition": "attachment"}],"custom_variables": {"user_id": "45982","batch_id": "PSJ-12"},"headers": {"X-Message-Source": "dev.mydomain.com"},"subject":' + email_title +',"text":' + full_body + ',"category": "API Test"}'
